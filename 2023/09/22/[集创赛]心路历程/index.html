<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>【集创赛】紫光同创杯国一的心路历程 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 写在前面​	好多佬们问我开不开源，这个等我考完研吧，先写一篇学习路线给大家参考，同时鼓励大家多多参与科创竞赛，相信自己，只要肯学，都会有的。     up算是一个小白，用了八个月时间全栈过了一遍FPGA，上位机开发，YOLO模型部署，本来以为能够稳3争2， 没想到拿了国一，也算是运气比较好吧。当然也付出了相当多的努力，别人开始考研的时候我还在学FPGA，每天早上8点学到晚上11点，有时候会熬夜">
<meta property="og:type" content="article">
<meta property="og:title" content="【集创赛】紫光同创杯国一的心路历程">
<meta property="og:url" content="http://example.com/2023/09/22/[%E9%9B%86%E5%88%9B%E8%B5%9B]%E5%BF%83%E8%B7%AF%E5%8E%86%E7%A8%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 写在前面​	好多佬们问我开不开源，这个等我考完研吧，先写一篇学习路线给大家参考，同时鼓励大家多多参与科创竞赛，相信自己，只要肯学，都会有的。     up算是一个小白，用了八个月时间全栈过了一遍FPGA，上位机开发，YOLO模型部署，本来以为能够稳3争2， 没想到拿了国一，也算是运气比较好吧。当然也付出了相当多的努力，别人开始考研的时候我还在学FPGA，每天早上8点学到晚上11点，有时候会熬夜">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221433221.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221501321.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221537510.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221622521.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221629738.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221641042.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221732078.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221741605.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221810995.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221823518.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221832905.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221848080.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222020237.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222344480.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222351424.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222358926.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222819968.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222906970.png">
<meta property="og:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222941767.png">
<meta property="article:published_time" content="2023-09-22T13:16:59.000Z">
<meta property="article:modified_time" content="2023-09-22T14:30:37.621Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="集创赛">
<meta property="article:tag" content="FPGA">
<meta property="article:tag" content="紫光同创">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221433221.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-[集创赛]心路历程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/22/%5B%E9%9B%86%E5%88%9B%E8%B5%9B%5D%E5%BF%83%E8%B7%AF%E5%8E%86%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2023-09-22T13:16:59.000Z" itemprop="datePublished">2023-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      【集创赛】紫光同创杯国一的心路历程
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-写在前面"><a href="#1-写在前面" class="headerlink" title="1 写在前面"></a>1 写在前面</h1><p>​	好多佬们问我开不开源，这个等我考完研吧，先写一篇学习路线给大家参考，同时鼓励大家多多参与科创竞赛，相信自己，只要肯学，都会有的。</p>
<p>    up算是一个小白，用了八个月时间全栈过了一遍FPGA，上位机开发，YOLO模型部署，本来以为能够稳3争2， 没想到拿了国一，也算是运气比较好吧。当然也付出了相当多的努力，别人开始考研的时候我还在学FPGA，每天早上8点学到晚上11点，有时候会熬夜加班，分赛区决赛和全国总决赛基本上通宵干活的。</p>
<p>&#x2F;&#x2F;************************************************防杠声明**************************************************&#x2F;&#x2F;</p>
<p>​	up只是小白，如果文中有技术错误or讲不清楚的地方，欢迎各位大佬评论区批评指正</p>
<p>&#x2F;&#x2F;************************************************防杠声明**************************************************&#x2F;&#x2F;</p>
<h2 id="1-1-专业背景"><a href="#1-1-专业背景" class="headerlink" title="1.1 专业背景"></a>1.1 专业背景</h2><p>​	up是微电子学院，集成电路设计与集成系统专业的，大二（2022年）有FPGA的专业课，学习了一些基础的verilog语法，用zynq7020做了一个硬件串口。</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221433221.png" alt="image-20230922221433221"></p>
<p>​	实际上up的基础一般，跟视频相关，接口相关（VESA HDMI PCIE ETH HSST）也是一点点学起来的，大家大可以把我当作小白。</p>
<p>​	因为对FPGA有那么点熟悉，所以集创赛选择赛道的时候选择了FPGA赛道，又对视频处理有那么一点点兴趣，所以选择了<strong>紫光同创杯</strong>。</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221501321.png" alt="image-20230922221501321"></p>
<h2 id="1-2-团队分工"><a href="#1-2-团队分工" class="headerlink" title="1.2 团队分工"></a>1.2 团队分工</h2><p>三人小队原始分工：</p>
<p>up本人：FPGA数据链路和算法；</p>
<p>队友A：PCIe上位机；</p>
<p>队友B：上位机YOLO模型部署；</p>
<p>实际分工：</p>
<p>up本人：全栈过了一遍FPGA设计，上位机设计，YOLO模型部署和优化；</p>
<p>队友A：六七月去了夏令营，PCIe上位机没做完，被up接手了，八月回来做上位机GUI优化和一部分视频算法；</p>
<p>队友B：前期完成了yolo的部署和部分功能的实现，另一方面为三人小队顶住了课业压力（小学期实习课程团队答辩），七八月暑假回家了，在他指导下up一周速通了yolo的环境搭建和部署，后续又做了软件的优化，模型的量化和加速；</p>
<h2 id="1-3-心路历程"><a href="#1-3-心路历程" class="headerlink" title="1.3 心路历程"></a>1.3 心路历程</h2><p>原谅我垃圾的版本控制（雾</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221537510.png" alt="image-20230922221537510"></p>
<ul>
<li><strong>1~2月</strong>：选定赛题，开始学习FPGA（可以看看我B站笔记的），学习VESA规格，X家的DMA IP，VDMA IP等等，初步了解帧缓存、AXI协议等等；</li>
<li><strong>3月</strong>：忙着开学考试、做学院的PPT，我们跟组委会借了板子，也自己买了一块，三月底开始尝试PDS和板子的一些基础功能，跟着奇哥复习AXI总线（奇哥的AXI真的讲的很透彻，建议大家都看看，资料汇总我放在后面），三月底基本上了解紫光DDR IP的使用，开始尝试经过DDR帧缓存的环回；</li>
<li><strong>4月</strong>：四月初做完了一路AXI主机的DDR缓存，实现了HDMI视频环回；然后开始了解视频缩放，根据双线性插值算法，自己写了verilog逻辑（有点费资源）；四月中下旬完善了四路AXI主机和AXI仲裁器，做完了HDMI四路的视频环回，后续买了双目摄像头，又改成了摄像头输入两路，不过bug不断，debug了很长时间；四月下旬开始学习PCIe协议，同时了解紫光PCIe IP的使用；这个时候视频环回的链路已经基本实现了；</li>
<li><strong>5月</strong>：校运会来了，学生会忙起来了，做项目时间减少，同时五月底还有专业课考试，忙起来了；继续研究PCIe，写了几个PCIe demo让队友做测试（有点像黑箱，一点点试，不过看紫光IP核给的仿真会清晰很多，配置过程，DMA过程等等，笔记放后边）；初赛交作品前已经实现了PCIe抓取单帧图片传输并保存为bmp文件，不过由于当初没考虑到大小端转换，所以传的图片有撕裂，而且色彩有问题；另外没有考虑好上位机怎么和YOLO传输数据；</li>
<li><strong>6月</strong>：一边开发FPGA的以太网UDP协议，一边摸鱼，等分赛区决赛结果，跟着正点原子过了MDIO，RGMII转GMII，ARP和UDP协议；进分赛区决赛后开始加足马力继续肝项目，这时候队友A去夏令营了，所以PCIe上位机被我接手了，摸清楚上位机结构之后，修修补补实现了PCIe抓取视频流并显示，通过虚拟摄像头传递给YOLO识别（这里是GPT提醒我们能够使用v4l2，队友B最后通过ffmpeg实现了视频流传递）</li>
<li><strong>7月</strong>：一边是小学期生产实习课程压力（这里感谢队友B帮我顶住了小组答辩的压力，让我有时间专注项目），一边是继续肝项目，在紫光PCIe测试平台的基础上，up改了一套测试平台v2.0，另外以太网遇到了点问题，分赛区决赛前没调出来（国赛也没调出来）；分赛区决赛，东北赛区五进一，没想到我们完成度相对来说很高，此时已经实现了HDMI输入，双目OV5640输入拼接，HDMI输出，PCIE输出，上位机能够顺利抓取和给YOLO识别，识别帧率40FPS左右（已经通过TensorRT加速），最后一等奖进了国赛。七月下旬队友B放假回家，我留校继续做项目，一个周速通YOLO，一个周对软件代码做了优化，帧率从40FPS提高到60FPS。</li>
<li><strong>8月</strong>：放假了，专注项目，队友A回归，开始做视频算法，做了直方图均衡，但是对彩色的并不友好，放弃了，做了简单的RGB YUV转换，在Y分量上操作，简单的视频增强，接着去做上位机GUI优化；我继续用一个周调网口，环回输入没调出来，但是做了以太网上位机；我继续用三天速通了光口，参考IEEE 802.3写了握手协议。最后只给了半个周来做PPT和文档完善，时间实在不够，我一边做文档一边又再看yolov8，最后提供了多种模型以供选择，19号从大连飞重庆，在机场延误四个小时，差点没交上作品，PPT和文档没做好是遗憾之一。</li>
</ul>
<h1 id="2-FPGA设计"><a href="#2-FPGA设计" class="headerlink" title="2 FPGA设计"></a>2 FPGA设计</h1><h2 id="2-1-结构框图"><a href="#2-1-结构框图" class="headerlink" title="2.1 结构框图"></a>2.1 结构框图</h2><p>​	提供了两种设计方案，由于PLG50H只有一个HSST资源，所以PCIE 光口不可兼得。</p>
<p>​	以双板方案为例，开发板1负责视频采集和拼接，提供了HDMI输入、缩放后通过光口环回，两路视频输入，OV5640两路视频输入，通过四路AXI主机仲裁实现帧缓存，输出时对四路画面进行拼接；开发板2负责图传，视频信号通过HDMI与开发板1连接，有一路AXI主机帧缓存，提供HDMI、PCIE、ETH三种输出方式。</p>
<p>单板设计方案：</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221622521.png" alt="image-20230922221622521"></p>
<p>双板设计方案：</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221629738.png" alt="image-20230922221629738"></p>
<p>输入视频规格：</p>
<table>
<thead>
<tr>
<th align="left">视频链路</th>
<th align="left">分辨率</th>
<th align="left">刷新率</th>
<th align="left">色彩格式&#x2F;色深</th>
</tr>
</thead>
<tbody><tr>
<td align="left">HDMI</td>
<td align="left">1920x1080</td>
<td align="left">60Hz</td>
<td align="left">RGB888</td>
</tr>
<tr>
<td align="left">OV5640</td>
<td align="left">960x540</td>
<td align="left">30Hz</td>
<td align="left">RGB565</td>
</tr>
<tr>
<td align="left">内部数据链路</td>
<td align="left">-</td>
<td align="left">与视频源相同</td>
<td align="left">32bits</td>
</tr>
<tr>
<td align="left">*HSST光纤环回</td>
<td align="left">960x540</td>
<td align="left">60Hz</td>
<td align="left">RGB565</td>
</tr>
</tbody></table>
<h2 id="2-2-双线性插值算法"><a href="#2-2-双线性插值算法" class="headerlink" title="2.2 双线性插值算法"></a>2.2 双线性插值算法</h2><p>双线性插值算法是根据网上的原理来写的，用了RAM资源来缓存，主要是确保好RAM或者FIFO预读出正确就行，保证de和像素数据同步，最后实现了1080P-&gt;540P，但是我这样写似乎比较浪费资源，有大佬有更好的写法</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221641042.png" alt="image-20230922221641042"></p>
<h2 id="2-3-AXI主机仲裁器与帧缓存"><a href="#2-3-AXI主机仲裁器与帧缓存" class="headerlink" title="2.3 AXI主机仲裁器与帧缓存"></a>2.3 AXI主机仲裁器与帧缓存</h2><p>​	为了保证视频正常输出，通过DDR缓存是必要的，紫光的DDR IP是精简的AXI FULL接口，所以AXI协议肯定要整明白，<strong>建议大家啃ARM的手册，另外可以和奇哥学</strong>，B站有视频（FPGA奇哥，链接放后面），讲的很透彻。</p>
<p>​	使用四路帧缓存设计，AXI主机能够实现地址自增、帧缓存切换等功能，同时读写状态机独立设计</p>
<p>​	为了保证四路视频正确缓存，还需要有序地把AXI主机接入DDR IP，多路视频缓存可以参考正点原子双目OV5640的例程，看看他的状态机设计和接入方法，这里我是自己写了仲裁器的读写状态机，对于不同的输入都有较好的兼容性。仲裁器根据每路FIFO的水位控制AXI握手。</p>
<p>这里debug了好久，修修补补，所以整体跳转逻辑有点乱。</p>
<p><strong>帧缓存设计：</strong></p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221732078.png" alt="image-20230922221732078"></p>
<p><strong>AXI写仲裁：</strong></p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221741605.png" alt="image-20230922221741605"></p>
<p><strong>AXI主机写操作：</strong></p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221810995.png" alt="image-20230922221810995"></p>
<p><strong>AXI读仲裁：</strong></p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221823518.png" alt="image-20230922221823518"></p>
<p><strong>AXI主机读操作：</strong></p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221832905.png" alt="image-20230922221832905"></p>
<h2 id="2-4-视频拼接和HDMI输出"><a href="#2-4-视频拼接和HDMI输出" class="headerlink" title="2.4 视频拼接和HDMI输出"></a>2.4 视频拼接和HDMI输出</h2><p>​	这里是用了一个能够产生VESA时序的模块（本质上是计数器），能供提供vs，hs，de和输出扫描的xy坐标，根据上述信号控制每路读FIFO输出即可。要控制好输出像素和de信号对应，不然输出会出现倾斜或者错位。</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922221848080.png" alt="image-20230922221848080"></p>
<h2 id="2-5-PCIe接口"><a href="#2-5-PCIe接口" class="headerlink" title="2.5 PCIe接口"></a>2.5 PCIe接口</h2><p>​	这部分可以算是比赛的一个难点之一，但是大家进国赛了基本上都做出来了。</p>
<p>​	首先是要学习PCIe协议，这里推荐一个大佬写的：<a target="_blank" rel="noopener" href="http://blog.chinaaet.com/justlxy/p/5100053251">http://blog.chinaaet.com/justlxy/p/5100053251</a>，主要要理解PCIe TLP 和 Header类型，发送数据用Mwr 32比较多</p>
<p>​	然后还要看紫光的PCIe怎么用，<strong>这里要看他仿真的过程，RC如何配置EP，RC如何操控EP进行DMA</strong>，仿真看懂了可以上板子，通过debug核抓信号，进一步验证。</p>
<p>​	最后再自己魔改，写verilog和上位机，发送符合协议要求的TLP包，紫光这个PCIe IP给的是AXI-S接口，还算好用。</p>
<p>​	<strong>另外要多看IP手册，了解引脚定义和功能，以及例程的相关说明。</strong>而且PCIe需要搭配上位机食用，<strong>上位机主要涉及配置PCIe，分配DMA空间，控制FPGA采集，释放DMA空间</strong>。</p>
<p>​	下面是上位机程序控制FPGA开始传输数据的大致流程，ffmpeg是一个开源的视频工具，用于传递视频流。</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222020237.png" alt="image-20230922222020237"></p>
<h2 id="2-6-以太网接口"><a href="#2-6-以太网接口" class="headerlink" title="2.6 以太网接口"></a>2.6 以太网接口</h2><p>​	<strong>以太网可以跟着正点原子的FPGA课程学习，了解MDIO、RGMII转GMII、ARP、UDP等</strong>，RGMII转GMII可以参考小眼睛官方给的例程。</p>
<p>​	<strong>这里遇到的一个问题</strong>，就是开发板的两个网口对接之后（本来想做环回的），一个网口gmii转出来的rx_error信号一直拉高，另一个网口gmii的valid信号一直拉高，根本没法用，但是跟电脑网口或者其他开发板网口对接就没有这种问题。这个问题困扰了两个月，一直没有解决。决赛答辩的时候问了这个问题，徐工说可能是rx_delay设置的问题，这个还没有尝试。</p>
<p>​	由于上面这个问题，环回输入没做成，想让开发板和另一块开发板做远端环回的，但是存在断连的情况，有时候发送着发送着灯就灭了，画面停顿，过了几秒两个网口重新自协商继续传输。</p>
<p>​	最后只做了以太网发送视频到上位机，基于UDP协议，实现540P视频的发送，<strong>但是丢包严重，不得不在每个UDP包里面加上序号保证丢包不会造成大规模画面撕裂</strong>；</p>
<p>​	跟国特大佬聊了聊，他们实现了以太网口的输入，不过视频数据是上位机发送的。</p>
<h2 id="2-7-光模块（紫光HSST-IP）"><a href="#2-7-光模块（紫光HSST-IP）" class="headerlink" title="2.7 光模块（紫光HSST IP）"></a>2.7 光模块（紫光HSST IP）</h2><p>​	<strong>首先是看IP手册，然后看例程的仿真，观察HSST怎么工作的。</strong></p>
<p>​	<strong>这里有个坑点是HSST IP不完整，还需要用户自己实现握手，在复位后发送有序集和组码进行握手，字节对其，参考IEEE 802.3 36小节。</strong></p>
<p>​	在这基础上可以把HSST IP当成一个提供了GMII接口的PHY芯片，我在上面又套了一个UDP协议。</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222344480.png" alt="image-20230922222344480"></p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222351424.png" alt="image-20230922222351424"></p>
<h1 id="3-上位机设计"><a href="#3-上位机设计" class="headerlink" title="3 上位机设计"></a>3 上位机设计</h1><h2 id="3-1-GUI设计"><a href="#3-1-GUI设计" class="headerlink" title="3.1 GUI设计"></a>3.1 GUI设计</h2><p>紫光的PCIe测试平台魔改过来的，可视化界面用的gtk库，用法和QT很像，照猫画虎地增加了很多功能。</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222358926.png" alt="image-20230922222358926"></p>
<h2 id="3-2-PCIe上位机"><a href="#3-2-PCIe上位机" class="headerlink" title="3.2 PCIe上位机"></a>3.2 PCIe上位机</h2><p>​	紫光原本提供的PCIe测试平台只能在ubuntu16.04使用，后来我迁移到了ubuntu23.04，<strong>主要是linux PCIe分配DMA内存和释放内存的函数有了更新</strong>，旧版函数没办法在新系统里面使用，在新系统想要编译成功还需要换掉这些函数，这里还要感谢实验室小伙伴的帮助，相关内容在网上有资料。</p>
<p>​	<strong>PCIe上位机主要是要看懂官方给的代码和功能对应的关系，如何分配内存，如何通知FPGA开始DMA操作，看懂了才能魔改驱动。</strong>原本限制DMA大小4096Byte，我们改成了DMA大小是4096x1024Byte，刚好大于1920x1080x2Byte，可以用于视频传输。</p>
<p>​	上位机同样是用了帧缓存设计，根据PCIe TLP包带的数据判断哪一帧是最新帧，从而让程序把数据从内核态传递给用户态，再在用户态对视频数据做处理。</p>
<h2 id="3-3-以太网上位机"><a href="#3-3-以太网上位机" class="headerlink" title="3.3 以太网上位机"></a>3.3 以太网上位机</h2><p>​	以太网上位机比PCIe上位机好写多了，由于底层驱动网卡厂家给你写好了，只需要会用<strong>socket</strong>编程就行，网上大把资料，用socket绑定好网口之后接手就行。</p>
<p>​	另外如果有能力可以在FPGA端写好ARP协议，和上位机交换一下IP和MAC，不然用静态IP、上位机ARP缓存写死了也行。</p>
<h2 id="3-4-上位机的数据链路"><a href="#3-4-上位机的数据链路" class="headerlink" title="3.4 上位机的数据链路"></a>3.4 上位机的数据链路</h2><p>​	在GPT的提醒下，我们使用了<strong>V4L2</strong>和<strong>FFMPEG</strong>，将视频流传递给&#x2F;dev&#x2F;video0，YOLO和其他应用调用虚拟摄像头就可以读取到视频流。</p>
<p>​	上位机集成的YOLO开关通过**.sh**脚本实现C对python的调用。</p>
<p>​	当然传递视频和调用yolo的方法还有很多，这里只是一种思路。</p>
<h1 id="4-AI算法部署"><a href="#4-AI算法部署" class="headerlink" title="4 AI算法部署"></a>4 AI算法部署</h1><h2 id="4-1-模型选择和数据集处理"><a href="#4-1-模型选择和数据集处理" class="headerlink" title="4.1 模型选择和数据集处理"></a>4.1 模型选择和数据集处理</h2><p>​	这里我们选择了YOLO的模型，提供了YOLO V5S V5M V8N V8S V8M多个模型以供调用，均训练了150轮。（下面这个图我们费了老大劲了，在AUTODL平台上租了卡连着跑了好久，虽然理论上v8要好不少，但是实际检测的时候感觉v5效果更好一些）</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222819968.png" alt="image-20230922222819968"></p>
<p>​	关于YOLO，CSDN上有很多资料，保姆级手把手教你配环境，标注，划分数据集，训练，检测。部署好YOLO之后可以看看YOLO检测代码（detect.py）的解读，如果不需要深入理解，看懂检测代码也就够了。</p>
<p>​	另外YOLO V8把各种功能都封成API了，所以建议参考YOLO官方文档，看懂了v5，学v8也很快。</p>
<p>​	我们选用了官方提供的交通灯数据集（VOC数据集中的一个小类好像），但是确实一般，训练好后map只有0.65+，国一的几支队伍好像没用官方给的，而是直接用了COCO。</p>
<h2 id="4-2-模型量化和加速"><a href="#4-2-模型量化和加速" class="headerlink" title="4.2 模型量化和加速"></a>4.2 模型量化和加速</h2><p>​	量化主要是将FP32转换为FP16，上面的图可以看见速度提高了很多；</p>
<p>​	加速使用了英伟达的<strong>TensorRT</strong>推理框架，原理不多介绍，在降低一些精度的情况下大幅提高了推理速度，部署CSDN上也有很多。</p>
<p>​	另外16：9输入的视频，在YOLO选择输入图片参数的时候可以将640x640改成384x640，这样速度会快很多，反正宽度不够的也是补无用数据。</p>
<h2 id="4-3-软件优化"><a href="#4-3-软件优化" class="headerlink" title="4.3 软件优化"></a>4.3 软件优化</h2><p>​	其实v5官方提供的代码有一个问题，用opencv库进行数据的载入和显示（cv2.read()和cv2.imshow()），这很吃CPU和内存，通过line_profiler性能分析工具可以分析每段代码的用时，尝试了多种方法之后发现子线程输入，主线程推理，子进程显示的帧数最高，从40FPS提高到了60FPS，这算是我们一个创新点。<br>​	这里补充一句，<strong>Python的效率是不如C++的，不过up是小白，Python会比较友好，用C++写YOLO性能会好不少。</strong></p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222906970.png" alt="image-20230922222906970"></p>
<p>ps.赛题完成情况：</p>
<p><img src="C:\Users\FLY-TT\AppData\Roaming\Typora\typora-user-images\image-20230922222941767.png" alt="image-20230922222941767"></p>
<h1 id="5-学习资料汇总"><a href="#5-学习资料汇总" class="headerlink" title="5 学习资料汇总"></a>5 学习资料汇总</h1><h2 id="5-1-他山之石，可以攻玉"><a href="#5-1-他山之石，可以攻玉" class="headerlink" title="5.1 他山之石，可以攻玉"></a>5.1 他山之石，可以攻玉</h2><ul>
<li>小眼睛官方例程</li>
<li>紫光IP手册（不管是谁家，手册肯定是要啃的）</li>
<li>正点原子FPGA开发指南（正点原子资料开源，而且对新手友好，很多设计可以参考），视频教程：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Ec411K791/?spm_id_from=333.999.0.0&amp;vd_source=789bfbff82733918b995c9c278a70ea0">https://www.bilibili.com/video/BV1Ec411K791/?spm_id_from=333.999.0.0&amp;vd_source=789bfbff82733918b995c9c278a70ea0</a></li>
<li>各种协议的原始文档（如AMBA IEEE 802.3等）</li>
<li>AXI和其他FPGA设计学习资料：<a target="_blank" rel="noopener" href="https://space.bilibili.com/497026889?spm_id_from=333.337.0.0">FPGA奇哥</a></li>
<li>PCIe学习资料：<a target="_blank" rel="noopener" href="http://blog.chinaaet.com/justlxy/p/5100053251">http://blog.chinaaet.com/justlxy/p/5100053251</a></li>
<li>手把手搭建yolov5：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1f44y187Xg/?spm_id_from=333.999.top_right_bar_window_custom_collection.content.click&amp;vd_source=789bfbff82733918b995c9c278a70ea0">https://www.bilibili.com/video/BV1f44y187Xg/?spm_id_from=333.999.top_right_bar_window_custom_collection.content.click&amp;vd_source=789bfbff82733918b995c9c278a70ea0</a>（这个up在CSDN有图文教程）</li>
<li>一行行读懂yolov5：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Dt4y1x7Fz/?spm_id_from=333.337.top_right_bar_window_custom_collection.content.click&amp;vd_source=789bfbff82733918b995c9c278a70ea0">https://www.bilibili.com/video/BV1Dt4y1x7Fz/?spm_id_from=333.337.top_right_bar_window_custom_collection.content.click&amp;vd_source=789bfbff82733918b995c9c278a70ea0</a>（看懂了就可以瞎改v5了）</li>
</ul>
<h2 id="5-2-UP自己的笔记"><a href="#5-2-UP自己的笔记" class="headerlink" title="5.2 UP自己的笔记"></a>5.2 UP自己的笔记</h2><p>​	我认为养成做工程写blog的习惯很重要，所以一路上做了很多笔记，之前是在b站记的，但是感觉编辑器不友好，所以改用有道云了。（2023.9.22补充，现在开始同步到github上了）</p>
<p>​	防杠声明，由于笔记是随着工程一点点写的，早期工程有bug，后续改进后笔记没更新，大家做个参考即可。</p>
<p>1.紫光DDR IP与Modelsim的安装与使用:</p>
<p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/9yuHHCgu">https://note.youdao.com/s/9yuHHCgu</a></p>
<p>2.VESA Monitor Timing Standard 时序实现与HDMI输出:</p>
<p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/ExhGhZTu">https://note.youdao.com/s/ExhGhZTu</a></p>
<p>3.基于紫光FIFO IP和DDR IP的HDMI环回实验</p>
<p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/KmRKDEAm">https://note.youdao.com/s/KmRKDEAm</a></p>
<p>4.基于FPGA的双线性插值法实现视频缩放</p>
<p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/LZGig5Lo">https://note.youdao.com/s/LZGig5Lo</a></p>
<p>5.AXI多主机单从机仲裁器与四路视频环回</p>
<p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/XnX3b3fq">https://note.youdao.com/s/XnX3b3fq</a></p>
<p>6.解构紫光PCIE IP</p>
<p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/U6H3m1a6">https://note.youdao.com/s/U6H3m1a6</a></p>
<p>7.以太网接口与协议</p>
<p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/aGw6AUt2">https://note.youdao.com/s/aGw6AUt2</a></p>
<p>8.解构紫光HSST IP</p>
<p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/BCYt4itk">https://note.youdao.com/s/BCYt4itk</a></p>
<p>*PDS啸寄巧：</p>
<p><a target="_blank" rel="noopener" href="https://note.youdao.com/s/G8B3qWwS">https://note.youdao.com/s/G8B3qWwS</a></p>
<p>​	写完了，希望大家给up一个关注+三连！！！有问题可以在b站留言，有道云的评论不一定能看到。</p>
<hr>
<p>2023.9.22 尝试在github搭建了blog，后续可能会考虑更细其他blog或者项目上去，欢迎大家关注啊</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/22/[%E9%9B%86%E5%88%9B%E8%B5%9B]%E5%BF%83%E8%B7%AF%E5%8E%86%E7%A8%8B/" data-id="clmunuqlc0000p8wt76seahy1" data-title="【集创赛】紫光同创杯国一的心路历程" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FPGA/" rel="tag">FPGA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%B4%AB%E5%85%89%E5%90%8C%E5%88%9B/" rel="tag">紫光同创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9B%86%E5%88%9B%E8%B5%9B/" rel="tag">集创赛</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/09/22/test-blog/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          test_blog 这是一个测试的blog
        
      </div>
    </a>
  
  
    <a href="/2023/09/22/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/FPGA/" rel="tag">FPGA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/" rel="tag">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/" rel="tag">test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B4%AB%E5%85%89%E5%90%8C%E5%88%9B/" rel="tag">紫光同创</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%88%9B%E8%B5%9B/" rel="tag">集创赛</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/FPGA/" style="font-size: 10px;">FPGA</a> <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/test/" style="font-size: 10px;">test</a> <a href="/tags/%E7%B4%AB%E5%85%89%E5%90%8C%E5%88%9B/" style="font-size: 10px;">紫光同创</a> <a href="/tags/%E9%9B%86%E5%88%9B%E8%B5%9B/" style="font-size: 10px;">集创赛</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/22/test-blog/">test_blog 这是一个测试的blog</a>
          </li>
        
          <li>
            <a href="/2023/09/22/%5B%E9%9B%86%E5%88%9B%E8%B5%9B%5D%E5%BF%83%E8%B7%AF%E5%8E%86%E7%A8%8B/">【集创赛】紫光同创杯国一的心路历程</a>
          </li>
        
          <li>
            <a href="/2023/09/22/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>